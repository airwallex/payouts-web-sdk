default:
  image: node:14.19.0

variables:
  KUBERNETES_CPU_REQUEST: 4
  KUBERNETES_CPU_LIMIT: 4
  KUBERNETES_MEMORY_REQUEST: 8Gi
  KUBERNETES_MEMORY_LIMIT: 8Gi

cache:
  key:
    files:
      - yarn.lock
      - package.json
  paths:
    - .yarn
    - node_modules

.build-and-test-rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event' || $CI_COMMIT_BRANCH == 'master'

stages:
  - build-and-test
  - create-release

build:
  extends:
    - .build-and-test-rules
  stage: build-and-test
  script:
    - pwd
    - yarn install --frozen-lockfile
    - yarn build
  artifacts:
    paths:
      - dist
      - node_modules

test:
  extends:
    - .build-and-test-rules
  stage: build-and-test
  coverage: /All\sfiles.*?\s+(\d+.\d+)/
  script:
    - pwd
    - yarn install --frozen-lockfile
    - yarn lint
    - yarn test
  artifacts:
    paths:
      - coverage

release:
  stage: create-release
  rules:
    - if: $CI_COMMIT_BRANCH == 'master'
      when: manual
  script:
    - yarn release
